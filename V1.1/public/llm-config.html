<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentCommander - LLM Configuration</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #58a6ff; margin-bottom: 10px; }
    h2 { color: #8b949e; font-size: 1.2rem; margin: 30px 0 15px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
    .subtitle { color: #8b949e; margin-bottom: 30px; }

    /* Cards */
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .card-title { font-weight: 600; color: #c9d1d9; }

    /* Provider Grid */
    .provider-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 15px;
    }
    .provider-card {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
    }
    .provider-card.active { border-color: #238636; }
    .provider-card.inactive { opacity: 0.6; }
    .provider-name {
      font-weight: 600;
      color: #c9d1d9;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .provider-desc { font-size: 0.85rem; color: #8b949e; margin: 8px 0; }
    .provider-stats { display: flex; gap: 15px; margin-top: 10px; }
    .stat { font-size: 0.85rem; }
    .stat-value { font-weight: 600; color: #58a6ff; }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
    .form-row .form-group { flex: 1; min-width: 150px; }
    label {
      display: block;
      font-size: 0.9rem;
      color: #8b949e;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 8px 12px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 0.95rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #58a6ff;
    }
    input[type="number"] { width: 80px; }

    /* Buttons */
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary { background: #238636; color: white; }
    .btn-primary:hover { background: #2ea043; }
    .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .btn-secondary:hover { background: #30363d; }
    .btn-danger { background: #da3633; color: white; }
    .btn-danger:hover { background: #f85149; }

    /* Routing Rules */
    .routing-table { width: 100%; border-collapse: collapse; }
    .routing-table th, .routing-table td {
      padding: 10px 15px;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
    .routing-table th { color: #8b949e; font-weight: 500; }
    .routing-table select { width: 100%; }

    /* Toggle */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #30363d;
    }
    .toggle-label { color: #c9d1d9; }
    .toggle-desc { font-size: 0.85rem; color: #8b949e; }
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #30363d;
      border-radius: 24px;
      transition: .4s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: .4s;
    }
    .toggle input:checked + .toggle-slider { background-color: #238636; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }

    /* Status */
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-active { background: #238636; color: white; }
    .status-inactive { background: #30363d; color: #8b949e; }
    .status-warning { background: #9e6a03; color: white; }

    /* Messages */
    .message {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }
    .message.success { display: block; background: #1f3a26; border: 1px solid #238636; color: #3fb950; }
    .message.error { display: block; background: #3d1a1a; border: 1px solid #da3633; color: #f85149; }

    /* Footer */
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #30363d;
      text-align: center;
      color: #8b949e;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LLM Configuration</h1>
    <p class="subtitle">Configure which AI models handle different types of tasks</p>

    <div id="message" class="message"></div>

    <!-- Agent Pool Configuration -->
    <h2>Agent Pool</h2>
    <div class="card">
      <p style="margin-bottom: 15px; color: #8b949e;">
        Configure how many agents run for each LLM provider. Changes require container restart.
      </p>
      <div class="provider-grid" id="provider-grid">
        <!-- Populated by JS -->
      </div>
      <div style="margin-top: 20px;">
        <button class="btn-primary" onclick="saveAgentCounts()">Save Agent Configuration</button>
        <span style="margin-left: 15px; color: #8b949e; font-size: 0.85rem;">
          Note: Restart containers to apply changes
        </span>
      </div>
    </div>

    <!-- Task Routing Rules -->
    <h2>Task Routing</h2>
    <div class="card">
      <p style="margin-bottom: 15px; color: #8b949e;">
        Define which LLM provider handles each type of task.
      </p>
      <table class="routing-table">
        <thead>
          <tr>
            <th>Task Type</th>
            <th>Description</th>
            <th>Provider</th>
          </tr>
        </thead>
        <tbody id="routing-tbody">
          <!-- Populated by JS -->
        </tbody>
      </table>
      <div style="margin-top: 20px;">
        <button class="btn-primary" onclick="saveRoutingRules()">Save Routing Rules</button>
      </div>
    </div>

    <!-- Cost Optimization -->
    <h2>Cost Optimization</h2>
    <div class="card">
      <div class="toggle-row">
        <div>
          <div class="toggle-label">Enable Cost Optimization</div>
          <div class="toggle-desc">Route simple tasks to cheaper models when possible</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="cost-optimization">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-row">
        <div>
          <div class="toggle-label">Prefer Local Models</div>
          <div class="toggle-desc">Use Ollama for non-critical tasks (free, but slower)</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="prefer-local">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div style="margin-top: 20px;">
        <button class="btn-primary" onclick="saveCostSettings()">Save Cost Settings</button>
      </div>
    </div>

    <!-- API Keys -->
    <h2>API Keys</h2>
    <div class="card">
      <p style="margin-bottom: 15px; color: #8b949e;">
        Configure API keys for each provider. Keys are stored securely in the database.
      </p>
      <div id="api-keys-form">
        <div class="form-row">
          <div class="form-group">
            <label>Grok (xAI) API Key</label>
            <input type="password" id="key-grok" placeholder="xai-...">
          </div>
          <div class="form-group">
            <label>OpenAI API Key</label>
            <input type="password" id="key-openai" placeholder="sk-...">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Claude OAuth Token</label>
            <input type="password" id="key-claude" placeholder="sk-ant-oat01-...">
          </div>
          <div class="form-group">
            <label>Ollama Host</label>
            <input type="text" id="ollama-host" placeholder="http://localhost:11434" value="http://host.docker.internal:11434">
          </div>
        </div>
      </div>
      <div style="margin-top: 20px;">
        <button class="btn-primary" onclick="saveApiKeys()">Save API Keys</button>
      </div>
    </div>

    <div class="footer">
      AgentCommander V1.1 - Multi-LLM Agent Pool
    </div>
  </div>

  <script>
    // Task types with descriptions
    const TASK_TYPES = [
      { id: 'coding', name: 'Coding', desc: 'File creation, modifications, implementations' },
      { id: 'analysis', name: 'Analysis', desc: 'Code review, debugging, explanations' },
      { id: 'review', name: 'Review', desc: 'PR reviews, code quality checks' },
      { id: 'planning', name: 'Planning', desc: 'Architecture, design decisions' },
      { id: 'chat', name: 'Chat', desc: 'General questions, conversations' },
    ];

    // Provider definitions
    const PROVIDERS = [
      { id: 'claude-code', name: 'Claude Code', desc: 'Agentic coding with tool use', cost: 15, tools: true },
      { id: 'grok', name: 'Grok', desc: 'Fast and cost-effective', cost: 10, tools: false },
      { id: 'openai', name: 'OpenAI GPT', desc: 'GPT-4o and other models', cost: 10, tools: false },
      { id: 'ollama', name: 'Ollama (Local)', desc: 'Free local models', cost: 0, tools: false },
    ];

    let currentConfig = null;

    // Load configuration
    async function loadConfig() {
      try {
        const res = await fetch('/api/llm/config');
        currentConfig = await res.json();
        renderProviderGrid();
        renderRoutingTable();
        renderCostSettings();
      } catch (err) {
        showMessage('Failed to load configuration', 'error');
      }
    }

    // Render provider grid
    function renderProviderGrid() {
      const grid = document.getElementById('provider-grid');
      grid.innerHTML = PROVIDERS.map(p => {
        const countKey = `${p.id.replace('-', '_')}_agent_count`;
        const count = currentConfig?.[countKey] ?? (p.id === 'claude-code' ? 3 : 0);
        const isActive = count > 0;

        return `
          <div class="provider-card ${isActive ? 'active' : 'inactive'}">
            <div class="provider-name">
              ${p.name}
              ${p.tools ? '<span class="status-badge status-active">Tools</span>' : ''}
            </div>
            <div class="provider-desc">${p.desc}</div>
            <div class="provider-stats">
              <div class="stat">Cost: <span class="stat-value">$${p.cost}/M</span></div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
              <label>Agent Count</label>
              <input type="number" id="count-${p.id}" value="${count}" min="0" max="10">
            </div>
          </div>
        `;
      }).join('');
    }

    // Render routing table
    function renderRoutingTable() {
      const tbody = document.getElementById('routing-tbody');
      const rules = currentConfig?.routing_rules || {};

      tbody.innerHTML = TASK_TYPES.map(t => {
        const selected = rules[t.id] || 'claude-code';
        return `
          <tr>
            <td><strong>${t.name}</strong></td>
            <td style="color: #8b949e;">${t.desc}</td>
            <td>
              <select id="route-${t.id}">
                ${PROVIDERS.map(p => `
                  <option value="${p.id}" ${selected === p.id ? 'selected' : ''}>
                    ${p.name} ${p.id === 'claude-code' ? '(Recommended)' : ''}
                  </option>
                `).join('')}
              </select>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Render cost settings
    function renderCostSettings() {
      document.getElementById('cost-optimization').checked = currentConfig?.cost_optimization_enabled || false;
      document.getElementById('prefer-local').checked = currentConfig?.prefer_local_models || false;
    }

    // Save agent counts
    async function saveAgentCounts() {
      const data = {
        claude_agent_count: parseInt(document.getElementById('count-claude-code').value) || 0,
        grok_agent_count: parseInt(document.getElementById('count-grok').value) || 0,
        openai_agent_count: parseInt(document.getElementById('count-openai').value) || 0,
        ollama_agent_count: parseInt(document.getElementById('count-ollama').value) || 0,
      };

      try {
        const res = await fetch('/api/llm/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          showMessage('Agent configuration saved! Restart containers to apply.', 'success');
          loadConfig();
        } else {
          showMessage('Failed to save configuration', 'error');
        }
      } catch (err) {
        showMessage('Failed to save configuration', 'error');
      }
    }

    // Save routing rules
    async function saveRoutingRules() {
      const routing_rules = {};
      TASK_TYPES.forEach(t => {
        routing_rules[t.id] = document.getElementById(`route-${t.id}`).value;
      });

      try {
        const res = await fetch('/api/llm/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ routing_rules }),
        });

        if (res.ok) {
          showMessage('Routing rules saved!', 'success');
          loadConfig();
        } else {
          showMessage('Failed to save routing rules', 'error');
        }
      } catch (err) {
        showMessage('Failed to save routing rules', 'error');
      }
    }

    // Save cost settings
    async function saveCostSettings() {
      const data = {
        cost_optimization_enabled: document.getElementById('cost-optimization').checked,
        prefer_local_models: document.getElementById('prefer-local').checked,
      };

      try {
        const res = await fetch('/api/llm/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          showMessage('Cost settings saved!', 'success');
          loadConfig();
        } else {
          showMessage('Failed to save cost settings', 'error');
        }
      } catch (err) {
        showMessage('Failed to save cost settings', 'error');
      }
    }

    // Save API keys
    async function saveApiKeys() {
      const keys = [
        { provider: 'grok', api_key: document.getElementById('key-grok').value },
        { provider: 'openai', api_key: document.getElementById('key-openai').value },
        { provider: 'claude', api_key: document.getElementById('key-claude').value },
      ].filter(k => k.api_key);

      try {
        for (const key of keys) {
          await fetch('/api/llm/api-keys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(key),
          });
        }
        showMessage('API keys saved!', 'success');
        // Clear inputs
        document.getElementById('key-grok').value = '';
        document.getElementById('key-openai').value = '';
        document.getElementById('key-claude').value = '';
      } catch (err) {
        showMessage('Failed to save API keys', 'error');
      }
    }

    // Show message
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => { msg.className = 'message'; }, 5000);
    }

    // Load on page load
    loadConfig();
  </script>

  <!-- Electron-specific enhancements (loaded only when running in Electron) -->
  <script>
    // Check if running in Electron and load renderer helpers
    if (window.agentCommander?.isElectron) {
      console.log('[Electron] Running in desktop mode');

      // Dynamically load renderer.js
      const script = document.createElement('script');
      script.src = '/electron/renderer.js';
      document.body.appendChild(script);
    }
  </script>
</body>
</html>
