# =============================================================================
# ORCHESTRATOR CONTAINER (V1.1)
# =============================================================================
# The "God-Tier" orchestrator that coordinates all agents.
#
# Responsibilities:
# - Manage task queue (priority-based)
# - Coordinate agent pool via Redis pub/sub
# - Handle control surfaces (Telegram, Slack, Web)
# - Verify agent work (git checks, tests)
# - Manage recovery and escalation
#
# Does NOT run Claude Code directly - agents do that.
# =============================================================================

FROM oven/bun:1-alpine

WORKDIR /app

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    openssh-client

# Copy V1.1 package files
COPY V1.1/package.json V1.1/bun.lock* ./

# Install dependencies
RUN bun install --frozen-lockfile || bun install

# Copy V1.1 code
COPY V1.1/orchestrator/ ./orchestrator/
COPY V1.1/redis/ ./redis/
COPY V1.1/src/ ./src/
COPY V1.1/public/ ./public/
COPY V1.1/tsconfig.json ./

# Create directories
RUN mkdir -p /worktrees /.archon

# Expose health check and API port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Start orchestrator
CMD ["bun", "run", "orchestrator/index.ts"]
