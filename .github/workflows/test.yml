name: Test Suite

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # TypeScript Tests (Lugh Main Service)
  # ===========================================
  typescript:
    name: TypeScript Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run type-check

      - name: Lint
        run: bun run lint

      - name: Format check
        run: bun run format:check

      - name: Run tests with coverage
        # Run tests in specific order to avoid Bun mock.module() pollution
        run: |
          bun test --coverage src/db src/utils src/handlers src/clients src/adapters src/config
          bun test --coverage src/orchestrator

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: typescript-coverage
          path: coverage/
          retention-days: 14

  # ===========================================
  # Python Tests (LangGraph Service)
  # ===========================================
  python:
    name: Python Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: langgraph-service

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: langgraph-service/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .
          pip install pytest pytest-asyncio httpx

      - name: Install test dependencies
        run: |
          pip install langgraph langchain-core langchain-anthropic pydantic pydantic-settings structlog redis

      - name: Run tests
        run: pytest tests/ -v --tb=short
        continue-on-error: false

  # ===========================================
  # Docker Build Test
  # ===========================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Lugh TypeScript image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: lugh:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build LangGraph Python image
        uses: docker/build-push-action@v5
        with:
          context: ./langgraph-service
          push: false
          tags: lugh-langgraph:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # Integration Test (Services Can Start)
  # ===========================================
  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [typescript, python]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: lugh_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install TypeScript dependencies
        run: bun install --frozen-lockfile

      - name: Run database migrations
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d lugh_test -f migrations/000_combined.sql
        continue-on-error: true

      - name: Start Lugh service (background)
        run: |
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/lugh_test \
          TELEGRAM_BOT_TOKEN=test_token_not_real \
          LOAD_BUILTIN_COMMANDS=false \
          bun run start &
          sleep 8

      - name: Test health endpoint
        run: |
          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:3000/health; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 2
          done
          echo "❌ Health check failed after 5 attempts"
          exit 1

      - name: Test LLM proxy endpoint exists
        run: |
          curl -sf http://localhost:3000/api/llm/health && echo "✅ LLM proxy healthy" || echo "⚠️ LLM proxy not configured"

  # ===========================================
  # Summary Job
  # ===========================================
  test-summary:
    name: All Tests Pass
    runs-on: ubuntu-latest
    needs: [typescript, python, docker-build, integration]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "TypeScript: ${{ needs.typescript.result }}"
          echo "Python: ${{ needs.python.result }}"
          echo "Docker: ${{ needs.docker-build.result }}"
          echo "Integration: ${{ needs.integration.result }}"

          if [ "${{ needs.typescript.result }}" == "failure" ]; then
            echo "❌ TypeScript tests failed"
            exit 1
          fi
          if [ "${{ needs.python.result }}" == "failure" ]; then
            echo "❌ Python tests failed"
            exit 1
          fi
          if [ "${{ needs.docker-build.result }}" == "failure" ]; then
            echo "❌ Docker build failed"
            exit 1
          fi
          if [ "${{ needs.integration.result }}" == "failure" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi
          echo "✅ All tests passed!"
